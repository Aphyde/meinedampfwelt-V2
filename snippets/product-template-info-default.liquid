<div class="info_content product-single__sticky">       
  <div class="d-md-flex align-items-center justify-content-between mb-10">
    <h1 itemprop="name" class="product-single__title font-700 text-capitalize">{{ product.title }}</h1>

    {% if collection.previous_product or collection.next_product %}
    <div class="product-single__direction d-flex align-items-center">
      {% if collection.previous_product %}
      <div class="btn-direction"{% if settings.tooltip_enable %} data-toggle="tooltip" data-placement="top" title="{{ 'products.general.previous_product' | t }}"{% endif %}>
        {{ '<i class="rbb-icon-direction-36"></i>' | link_to: collection.previous_product.url, collection.previous_product.title }}
      </div>
      {% endif %}
      <a href="{{ collection.url }}" class="btn-collection d-block"{% if settings.tooltip_enable %} data-toggle="tooltip" data-placement="top" title="{{ 'products.general.back_to_collection' | t }}"{% endif %}><i class="rbb-icon-view-grid-1"></i></a>
      <div class="btn-direction"{% if settings.tooltip_enable %} data-toggle="tooltip" data-placement="top" title="{{ 'products.general.next_product' | t }}"{% endif %}>
        {% if collection.next_product %}
          {{ '<i class="rbb-icon-direction-39"></i>' | link_to: collection.next_product.url, collection.next_product.title }}
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  {% if settings.show_rating %}
    <div class="product-single__top-review mb-20 d-flex align-items-center">
      <div class="AirReviews-Widget AirReviews-Widget--Stars"></div>
      <a href="#AirReviews-BlockWrapper" class="btn-review__all text-uppercase font-700 c_h">{{ 'products.product.review_all_btn' | t }}</a>
    </div>
  {% endif %}

  {% render 'product-single-price', current_variant: product.selected_or_first_available_variant %}

  {% if section.settings.show_des %}
    <div class="product-single__shortdes" itemprop="description">{{ product.description | strip_html | truncatewords: 35 }}</div> 
  {% endif %}

  {% render 'product-single-deal' %}
  {% if section.settings.show_available %}
    {% render 'product-single-available' %}
  {% endif %}

  {% render 'product-single-info' %}

  <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" id="product-form-{{ section.id }}">
    {% render 'product-single-variant', current_variant: product.selected_or_first_available_variant %}

    <!-- PACKUNG BUTTONS – LINKSBÜNDIG AUF DESKTOP -->
    {%- assign pack_option_index = -1 -%}
    {%- assign pack_option_name = '' -%}
    {%- for opt in product.options_with_values -%}
      {%- assign lower_name = opt.name | downcase -%}
      {%- if lower_name contains 'packung' or lower_name contains 'pack' or lower_name contains 'stück' or lower_name contains 'menge' -%}
        {%- assign pack_option_index = forloop.index0 -%}
        {%- assign pack_option_name = opt.name -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}

    {%- if pack_option_index >= 0 and product.options_with_values[pack_option_index].values.size > 1 -%}
      <div class="mdw-packung-group" data-pack-index="{{ pack_option_index }}">
        {%- assign values = product.options_with_values[pack_option_index].values -%}
        {%- for val in values -%}
          {%- assign v_match = nil -%}
          {%- for v in product.variants -%}
            {%- if v.options[pack_option_index] == val -%}
              {%- assign v_match = v -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if v_match -%}
            {%- assign badge_id = 'mdw-badge-' | append: v_match.id -%}
            <label class="mdw-pack-option" for="mdw-radio-{{ v_match.id }}">
              <input
                type="radio"
                id="mdw-radio-{{ v_match.id }}"
                name="mdw_packung"
                value="{{ val }}"
                data-variant-id="{{ v_match.id }}"
                data-option-value="{{ val }}"
                {% if v_match.id == product.selected_or_first_available_variant.id %}checked{% endif %}
                {% unless v_match.available %}disabled{% endunless %}
              >
              <span class="mdw-radio-custom"></span>
              <span class Experiments.mdw-text">{{ val }}</span>
              <span class="mdw-price-wrapper">
                <span class="mdw-price">{{ v_match.price | money }}</span>
                <span class="mdw-unit-price" data-unit-for="{{ v_match.id }}">…</span>
              </span>
              <span id="{{ badge_id }}" class="mdw-badge" data-badge-for="{{ v_match.id }}">…</span>
            </label>
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- endif -%}

    {% render 'product-single-addtocart', current_variant: product.selected_or_first_available_variant %}
  </form>

  {% render 'product-single-share-ask' %}

  {% if viewtype == 'accordiontwo' %}
    {% render 'product-single-accordion', class: 'mt-45' %}
  {% endif %}

  {% render 'product-single-payment-shipping' %}
</div>

<!-- STYLES – LINKSBÜNDIG AUF DESKTOP -->
<style>
  .mdw-packung-group {
    margin: 1.2rem 0 1rem;
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    max-width: 500px;
    margin-left: 0; /* LINKSBÜNDIG */
    margin-right: auto;
  }

  .mdw-pack-option {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* LINKSBÜNDIG */
    background: #fff;
    border: 1px solid #e3e3e3;
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    min-height: 44px;
    user-select: none;
    width: 100%;
    max-width: 450px; /* SCHMALER */
    margin-left: 0; /* KEIN AUTO-CENTER */
  }

  .mdw-pack-option:hover:not(:has(input[disabled])) {
    border-color: #000;
    background: #fafafa;
    transform: translateY(-1px);
  }

  .mdw-pack-option input { display: none; }

  .mdw-radio-custom {
    width: 16px; height: 16px;
    border: 2px solid #ccc; border-radius: 50%;
    margin-right: 10px; flex-shrink: 0;
    position: relative;
    transition: all 0.2s ease;
  }

  .mdw-pack-option:has(input:checked) .mdw-radio-custom {
    border-color: #000; background: #000;
  }

  .mdw-pack-option:has(input:checked) .mdw-radio-custom::after {
    content: ''; position: absolute;
    width: 6px; height: 6px; background: #fff;
    border-radius: 50%; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
  }

  .mdw-text {
    flex: 1; font-weight: 600; font-size: 14px; color: #000;
  }

  .mdw-price-wrapper {
    display: flex; align-items: baseline; gap: 6px; white-space: nowrap;
    margin-left: auto;
  }

  .mdw-price {
    font-weight: 600; font-size: 14px; color: #000;
  }

  .mdw-unit-price {
    font-size: 11px;
    color: #666;
    font-weight: 400;
    font-style: italic;
    white-space: nowrap;
  }

  .mdw-badge {
    background: #000; color: #fff;
    font-size: 11px; font-weight: 500;
    padding: 4px 8px; border-radius: 6px;
    margin-left: 8px; position: relative;
    opacity: 0; transform: scale(0.8);
    transition: all 0.25s ease;
  }

  .mdw-badge.visible { opacity: 1; transform: scale(1); }

  .mdw-badge::before {
    content: ""; position: absolute; left: -5px; top: 50%;
    transform: translateY(-50%);
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    border-right: 5px solid #000;
  }

  .mdw-pack-option:has(input[disabled]) {
    opacity: 0.5; cursor: not-allowed; pointer-events: none;
  }

  .mdw-pack-option:has(input:checked) {
    border-color: #000 !important; background: #f8f8f8;
  }

  @media (min-width: 600px) {
    .mdw-packung-group {
      gap: 10px;
      max-width: 450px;
      margin-left: 0; /* LINKSBÜNDIG */
    }
    .mdw-pack-option {
      padding: 11px 13px;
      justify-content: flex-start;
    }
    .mdw-text, .mdw-price { font-size: 15px; }
    .mdw-unit-price { font-size: 12px; }
    .mdw-badge { font-size: 12px; padding: 5px 9px; }
  }

  /* DROPDOWN AUSBLENDEN */
  form#product-form-{{ section.id }} [name*="options["][value*="{{ pack_option_name }}"],
  form#product-form-{{ section.id }} .selector-wrapper:has([name*="Packung"]),
  form#product-form-{{ section.id }} fieldset:has(legend:contains("{{ pack_option_name }}")) {
    display: none !important;
  }
</style>

<!-- SCRIPT – PREIS UPDATE + LINKSBÜNDIG -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('product-form-{{ section.id }}');
  if (!form) return;

  const group = form.querySelector('.mdw-packung-group');
  if (!group) return;

  const index = parseInt(group.dataset.packIndex);
  const variants = {{ product.variants | json }};
  const hiddenId = form.querySelector('input[name="id"]');

  // PREIS ELEMENTE FINDEN
  const priceWrapper = document.querySelector('.product-single__price, .price-wrapper, .price, [data-product-price]');
  const priceElement = priceWrapper?.querySelector('.price__regular, .price-item, [data-price]') || priceWrapper;

  // Baseline
  let baseline = variants.find(v => (v.options[index] || '').includes('1er'));
  if (!baseline) {
    const withUnits = variants.map(v => ({
      v, units: parseInt((v.options[index] || '').match(/\d+/)?.[0] || 1)
    })).filter(x => x.units > 0);
    withUnits.sort((a,b) => a.units - b.units);
    baseline = withUnits[0]?.v;
  }
  const baselineUnits = parseInt((baseline.options[index] || '').match(/\d+/)?.[0] || 1);
  const unitPrice = baseline.price / baselineUnits;

  group.querySelectorAll('.mdw-pack-option').forEach(label => {
    const input = label.querySelector('input');
    const vid = input.dataset.variantId;
    const v = variants.find(x => x.id == vid);
    if (!v) return;

    const units = parseInt((v.options[index] || '').match(/\d+/)?.[0] || 1);
    const expected = Math.round(unitPrice * units);
    const saving = expected - v.price;

    // Grundpreis pro Stück
    const unitEl = label.querySelector('.mdw-unit-price');
    if (units > 1) {
      const unitPriceFormatted = (v.price / units) / 100;
      unitEl.textContent = `${new Intl.NumberFormat('de-DE', {style:'currency',currency:'EUR', minimumFractionDigits: 2}).format(unitPriceFormatted)} / Stk.`;
      unitEl.style.display = '';
    } else {
      unitEl.style.display = 'none';
    }

    // Badge
    const badge = label.querySelector('.mdw-badge');
    if (saving > 1) {
      const pct = Math.round((saving / expected) * 100);
      badge.textContent = `Spare -${pct}%`;
      setTimeout(() => badge.classList.add('visible'), 10);
    } else {
      badge.style.display = 'none';
    }

    // PREIS UPDATE BEI KLICK
    input.addEventListener('change', () => {
      if (hiddenId) hiddenId.value = vid;

      const money = new Intl.NumberFormat('de-DE', {style:'currency',currency:'EUR'}).format(v.price / 100);
      if (priceElement) {
        priceElement.innerHTML = money;
      }

      form.dispatchEvent(new Event('change', {bubbles: true}));
      document.dispatchEvent(new CustomEvent('variant:changed', {detail: {variant: v}}));
      document.dispatchEvent(new CustomEvent('variantChange', {detail: {variant: v}}));
    });
  });

  // Dropdown ausblenden
  form.querySelectorAll('select, .selector-wrapper, fieldset').forEach(el => {
    if (el.innerHTML.includes('Packung') || el.innerHTML.includes('pack')) {
      el.style.display = 'none';
    }
  });
});
</script>
